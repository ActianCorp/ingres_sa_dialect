# SQLAlchemy Dialect Compliance Suite
## Overview and Setup

The following text is from the page [README.dialects.rst](https://github.com/sqlalchemy/sqlalchemy/blob/main/README.dialects.rst) of the SQLAlchemy GitHub repository.

> SQLAlchemy includes a [dialect compliance suite](https://github.com/sqlalchemy/sqlalchemy/tree/main/lib/sqlalchemy/testing/suite) that is usable by third party libraries, in the source tree at lib/sqlalchemy/testing/suite. There's no need for a third party dialect to run through SQLAlchemy's full testing suite, as a large portion of these tests do not have dialect-sensitive functionality. The "dialect compliance suite" should be viewed as the primary target for new dialects.

### Environment and Packages
These steps have been tested using the following environment:

    Microsoft Windows [Version 10.0.19045.4170]
    Ingres II 11.2.0 (a64.win/100) 15807
    set SQLALCHEMY_INGRES_ODBC_DRIVER_NAME=Actian II
    Python 3.10.7
    Packages:
      mock              5.1.0
      packaging         24.0
      pip               24.0
      pluggy            1.5.0
      pyodbc            5.1.0
      pyproject-api     1.6.1
      pypyodbc          1.3.6
      pytest            8.2.0
      setuptools        63.2.0
      SQLAlchemy        2.0.29.dev0
      sqlalchemy-ingres 0.0.7.dev3
      tox               4.15.0

### Configuration
DSN and directive for using the Ingres Requirements class in requirements.py:

    [db]
    ingres_odbc=ingres:///sqatestdb
    # ingres_odbc=ingres://testuid:testpwd@testhost:21064/testdb

    [sqla_testing]
    requirement_cls=sqlalchemy_ingres.requirements:Requirements

### Execution Example
The SQLAlchemy [dialect compliance suite](https://github.com/sqlalchemy/sqlalchemy/tree/main/lib/sqlalchemy/testing/suite) contains many test classes and most of these classes run multiple tests. At the time of this writing, the entire suite contains over 1500 individual tests.

This example will run all tests of the class: `DifficultParametersTest`

Contents of file test_suite_area.py:

    from sqlalchemy.testing.suite import (DifficultParametersTest)

Command to execute tests:

    pytest --db ingres_odbc --maxfail=100 test_suite_area.py --tb=no

## Known Issues

### Use of Alternate Schemas

When running the SQLAlchemy [dialect compliance suite](https://github.com/sqlalchemy/sqlalchemy/tree/main/lib/sqlalchemy/testing/suite), quite a few tests would fail with some form of the following error:

    sqlalchemy.exc.ProgrammingError: (pyodbc.ProgrammingError)
    ('42503', "[42503] [Actian][Actian II ODBC Driver][INGRES]
    CREATE TABLE: You may not create an object owned by 'test_schema'. (328737) (SQLExecDirectW)")
    [SQL:
    CREATE TABLE test_schema.test_table (
        id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
        data VARCHAR(50),
        PRIMARY KEY (id) )

The reason for the error is that the affected tests attempt to create and drop tables owned under schemas different than the current user.

Ingres does not support this kind of operation except in rare instances where the current user has security administrator and operator privilege or who is the DBA of the database. The user must then use the `SET SESSION AUTHORIZATION ...` command to set the effective user for the current session.

The following text about alternate schemas is taken from these SQLAlchemy GitHub pages: [README.unittests.rst](https://github.com/sqlalchemy/sqlalchemy/blob/main/README.unittests.rst), [changelog_14.rst](https://github.com/sqlalchemy/sqlalchemy/blob/main/doc/build/changelog/changelog_14.rst)

> Several tests require alternate usernames or schemas to be present, which are used to test dotted-name access scenarios. On some databases such as Oracle these are usernames, and others such as PostgreSQL and MySQL they are schemas. The requirement applies to all backends except SQLite and Firebird. The names are:  
>
>    test_schema
>    test_schema_2 (only used on PostgreSQL and mssql)
> 
> Please refer to your vendor documentation for the proper syntax to create these namespaces - the database user must have permission to create and drop tables within these schemas. Its perfectly fine to run the test suite without these namespaces present, it only means that a handful of tests which expect them to be present will fail.
> 
> Added a new flag to .DefaultDialect called supports_schemas; third party dialects may set this flag to False to disable SQLAlchemy's schema-level tests when running the test suite for a > third party dialect.

### Flag Added to the Ingres Dialect
Per discussion in [11366](https://github.com/sqlalchemy/sqlalchemy/discussions/11366) and additional research in internal ticket [II-14148](https://actian.atlassian.net/browse/II-14148), the setting `supports_schemas = False` will be added to the IngresDialect class via PR [50](https://github.com/ActianCorp/sqlalchemy-ingres/pull/50) so that when the dialect compliance suite is executed, any tests that use alternate schemas will be skipped.

Example comparison of results before and after adding the setting `supports_schemas = False`

Result | Before | After | Diff  
-- | -- | -- | --
Total Tests | 1531 | 1531 | -  
Passed | 336 | 473 | +137  
Failed | 63 | 173 | +110  
Errors | 798 | 30 | -768  
Skipped | 334 | 855 | +521  
Run Time | 17m 25s | 42s | -16m 43s  

